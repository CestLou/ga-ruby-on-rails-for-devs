Aplicación Rails MVC y Scaffold
===============================

Rails puede generar una aplicación funcional con sólo una linea de comando.

    $ rails new rails-basics

Modelo Vista Controlador
------------------------

Una solicitud HTTP es enviada al *controlador* por medio de la ruta definida en `config/routes.rb`. Un controlador es una clase que hereda de `ApplicationController`, la cual a su vez hereda de `ActionController::Base`. Generalmente será mostrada por la correspondiente *vista*, la cual es un template en ERB, HAML u otro formato que se pueda convertir a HTML. Esos template a menudo utilizan un *layout* específico. La vista comúnmente se completa con la información obtenida del *modelo*, la cual se obtiene de una base de datos.

Pruebas de integración
----------------------

Cree una nueva prueba.

    rails generate integration_test index

Esto crea una prueba en `test/integration/index_test.rb`. Le podemos agregar algo de contenido, comprobando que podemos mostrar la página index.html con su correspondiente título.

``` ruby
require 'test_helper'

class IndexTest < ActionDispatch::IntegrationTest
  fixtures :all

  test "fetches the index.html page" do
    get "/"
    assert_response :success
    assert_select "title", "Ruby on Rails: Bienvenido a bordo!"
  end

end
```

Los asserts [ActionDispatch::Assertions](http://apidock.com/rails/ActionDispatch/Assertions).

Ejecute las pruebas con `rake test`.

Cambie de SQL-Lite a PostgreSQL
-------------------------------

Heroku no soporta SQLLite. Vamos a realizar el cambio a PostgreSQL.

Cambie `sqlite` a `pg` en la `Gemfile` y ejecute `bundle install`.

Cree un rol de acceso.

    $ psql template1  

    create role rails with createdb login password 'password';

Edite `config/database.yml`.

``` yaml
common: &common
  adapter: postgresql
  username: rails
  password: password
  host: localhost
  port: 5432

development:
  <<: *common
  database: rails_development

test:
  <<: *common
  database: rails_test

production:
  <<: *common
  database: rails_production
```

Cree una base de datos.

    rake db:create:all

Assets
------

En Rails los assets estan precompilados.

    RAILS_ENV=production
    rake assets:precompile
    git add public/assets
    git commit -m "vendor compiled assets"

Deploy a Heroku
----------------

Heroku provee de hosting para aplicaciones creadas con Rails y soporte para el deploy en proyectos manejados con GIT. Cree una cuenta en [heroku.com](http://www.heroku.com/).

    gem install heroku
    heroku keys:add

Cree una aplicación.

    $ heroku create dblock-rails-mvc --stack cedar
    Creating dblock-rails-mvc... done, stack is cedar
    http://dblock-rails-mvc.herokuapp.com | git@heroku.com:dblock-rails-mvc.git

Configure un *heroku* remoto. Esto es un destino GIT al cual le enviaremos el código mediante el comando *push*. Puedes ver todos los destinos remotos con `git remote -v`.

    $ git remote add heroku git@heroku.com:dblock-rails-mvc.git

Envíe la aplicación a Heroku.

    $ git push heroku master

Abra el navegador con `heroku open`.

Scaffold Domain Model
---------------------

    rails generate scaffold Thing name:string description:string

Esto crea el modelo, el controlador, la vista, un script de migración de la base de datos, actualiza el esquema y crea las pruebas básicas.

Rakefile
--------

Las tareas son escritas en Ruby y se ejecutan con [Rake](https://github.com/jimweirich/rake). Rake necesita un archivo `Rakefile`, el cual importa el código de la aplicación. Puedes ejecutar `rake -T` para ver las tareas disponibles.

    $ rake -T
    rake about # List versions of all Rails frameworks and the environment
    ...

Ejercicio
---------

Cree una tarea de Rake en `lib/tasks` que cargue el archivo `database.yaml` y muestre la configuración de la base de datos para el entorno actual. Cuando ejecute esta tarea compruebe que el valor `database` está definido; quizás necesite definir `YAML::ENGINE.yamler = 'syck'`.

A continuación
==============

Vamos a reconstruir una [aplicación Rails MVC desde cero](4.3-rails-mvc-dev.md).
